<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido Online - SABOR A√áA√çTERIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Base font for the entire body */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for modal content */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        .modal-body::-webkit-scrollbar-track {
            background: #1f2937; /* Dark gray for track */
            border-radius: 10px;
        }
        .modal-body::-webkit-scrollbar-thumb {
            background: #581c87; /* Purple for thumb */
            border-radius: 10px;
        }
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #6b21a8; /* Darker purple on hover */
        }
        /* Hide spin buttons for number inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox compatibility */
        }
        /* Style for disabled checkboxes */
        input[type="checkbox"]:disabled + span {
            color: #6b7280; /* Gray out text */
            cursor: not-allowed;
        }
        /* Transition for alert modal */
        .alert-modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        /* Highlight radio button title when checked */
        input[type="radio"]:checked + div > .radio-title {
            color: #c084fc; /* Light purple */
        }
        /* Custom style for time input icon to make it visible on dark background */
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8); /* Invert colors to make it lighter */
        }
        /* Base styles for modals to enable transitions */
        .modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none; /* Disable interaction when hidden */
        }
        .modal.flex {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto; /* Enable interaction when visible */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div class="container mx-auto p-4 sm:p-8 max-w-4xl">

        <!-- Header Section -->
        <header class="text-center mb-8 p-6 rounded-2xl bg-gradient-to-tr from-black to-gray-800 text-white shadow-lg">
            <h1 class="text-5xl md:text-6xl font-black tracking-tight text-amber-400">SABOR A√áA√çTERIA</h1>
            <p class="text-lg md:text-xl mt-2 text-gray-300 opacity-90">Monte seu pedido online de forma f√°cil e r√°pida!</p>
            <p id="store-hours-display" class="text-md md:text-lg mt-3 text-gray-300 opacity-90 bg-white/10 rounded-full px-4 py-1 inline-flex items-center justify-center">
                <i class="fas fa-clock mr-2"></i> <span>Carregando hor√°rio...</span>
                <span id="store-status-indicator" class="ml-2 px-3 py-1 text-sm rounded-full"></span>
            </p>
        </header>

        <!-- Store Status and Delivery Time Banners -->
        <div id="store-status-banner" class="hidden"></div>
        <div id="delivery-time-banner" class="hidden"></div>

        <!-- Main Content Area - Product List -->
        <main class="space-y-8">
            <section id="tamanhos" class="bg-gray-800 p-6 rounded-2xl shadow-md">
                <h2 class="text-3xl font-bold text-purple-400 mb-4 border-b-2 border-purple-800 pb-2">Escolha o Tamanho</h2>
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Product cards will be rendered here by JavaScript -->
                </div>
            </section>
        </main>

        <!-- Footer Section -->
        <footer class="text-center mt-10 space-y-4">
            <div class="bg-gray-800 p-4 rounded-2xl shadow-md border-2 border-gray-700">
                 <h3 class="text-lg font-bold text-purple-400 mb-2 flex items-center justify-center gap-2">
                    <i class="fas fa-map-marker-alt"></i>
                    Nosso Endere√ßo
                </h3>
                 <p id="store-address-display" class="text-gray-300 text-base">
                    Carregando endere√ßo...
                </p>
            </div>
            <div class="text-gray-400 pt-2">
                <p>Siga-nos no Instagram: 
                    <a href="https://www.instagram.com/sabor_acaiteria/profilecard/?igsh=NjF2ZWMwNHNiNzI0" target="_blank" class="font-semibold text-purple-400 hover:underline">@sabor_acaiteria</a>
                </p>
            </div>
            <div class="mt-6">
                 <a href="#" onclick="app.openAdminPanel(event)" class="inline-block bg-amber-400 text-gray-900 font-bold py-3 px-6 rounded-lg hover:bg-amber-500 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <i class="fas fa-user-shield mr-2"></i>Painel do Administrador
                </a>
            </div>
        </footer>
    </div>

    <!-- WhatsApp Floating Button -->
    <a id="whatsapp-link" href="#" target="_blank" class="fixed bottom-5 left-5 z-50">
        <button class="bg-green-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center hover:bg-green-600 transition-transform transform hover:scale-110">
            <i class="fab fa-whatsapp text-3xl"></i>
        </button>
    </a>

    <!-- Cart Floating Button -->
    <div id="cart-button" class="fixed bottom-5 right-5 z-50 hidden">
        <button onclick="app.toggleCartModal()" class="bg-purple-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center hover:bg-purple-700 transition-transform transform hover:scale-110">
            <i class="fas fa-shopping-cart text-2xl"></i>
            <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center">0</span>
        </button>
    </div>

    <!-- Combo Size Selection Modal -->
    <div id="combo-size-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="combo-size-modal-title" class="text-2xl font-bold text-purple-400">Escolha o Tamanho do Combo</h3>
                <button onclick="app.closeComboSizeModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="combo-size-modal-body" class="p-6 space-y-4 overflow-y-auto modal-body">
                <!-- Size options will be rendered here by JavaScript -->
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700 flex justify-end">
                <button id="select-combo-size-btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-all flex items-center gap-2" disabled>
                    <i class="fas fa-arrow-right"></i> Continuar
                </button>
            </div>
        </div>
    </div>

    <!-- Item Customization Modal -->
    <div id="item-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="modal-title" class="text-2xl font-bold text-purple-400">Monte seu A√ßa√≠</h3>
                <button onclick="app.closeItemModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="modal-body" class="p-6 space-y-6 overflow-y-auto modal-body">
                <!-- Topping options will be rendered here by JavaScript -->
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700 flex justify-between items-center">
                <div>
                    <span class="text-lg font-medium text-gray-300">Total do Item:</span>
                    <span id="modal-item-total" class="text-2xl font-bold text-purple-400 ml-2">R$ 0,00</span>
                </div>
                <button id="add-to-cart-btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-all flex items-center gap-2">
                    <i class="fas fa-cart-plus"></i> Adicionar ao Carrinho
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="modal fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
         <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-purple-400">Seu Carrinho e Pedido</h3>
                <button onclick="app.toggleCartModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto modal-body">
                <div id="cart-items-container"></div>
                <div id="cart-summary-details" class="pt-4 mt-4 border-t border-gray-700 space-y-2 hidden">
                     <div class="flex justify-between text-gray-400">
                         <span>Subtotal</span>
                         <span id="cart-subtotal">R$ 0,00</span>
                     </div>
                     <div class="flex justify-between text-gray-400">
                         <span>Taxa de Entrega</span>
                         <span id="cart-delivery-fee">R$ 0,00</span>
                     </div>
                </div>
                <div id="checkout-form" class="space-y-4 pt-6 border-t border-gray-700 hidden">
                    <h4 class="text-xl font-bold text-gray-200">Informa√ß√µes do Pedido</h4>
                    <div id="delivery-options">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <label id="delivery-option-delivery" class="flex-1 flex items-center p-3 border-2 border-gray-600 rounded-lg cursor-pointer has-[:checked]:border-purple-500 has-[:checked]:bg-purple-900/50">
                                <input type="radio" name="delivery_option" value="delivery" class="hidden" checked>
                                <div class="flex items-center">
                                    <span class="mr-3"><i class="fas fa-motorcycle text-xl text-purple-400"></i></span>
                                    <div><span class="font-semibold text-gray-300 block radio-title">Delivery (Entrega)</span><span class="text-sm text-gray-500">20-60 min</span></div>
                                </div>
                            </label>
                            <label id="delivery-option-takeout" class="flex-1 flex items-center p-3 border-2 border-gray-600 rounded-lg cursor-pointer has-[:checked]:border-purple-500 has-[:checked]:bg-purple-900/50">
                                <input type="radio" name="delivery_option" value="takeout" class="hidden">
                                <div class="flex items-center">
                                    <span class="mr-3"><i class="fas fa-store text-xl text-purple-400"></i></span>
                                    <div><span class="font-semibold text-gray-300 block radio-title">Retirar na Loja</span><span class="text-sm text-gray-500">20-30 min</span></div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-400">Seu Nome</label>
                        <input type="text" id="customer-name" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base" required>
                    </div>
                    <div id="delivery-fields" class="space-y-4">
                         <div>
                            <label for="neighborhood" class="block text-sm font-medium text-gray-400">Selecione o Bairro</label>
                            <select id="neighborhood" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base">
                                <option value="" data-fee="0">-- Escolha uma op√ß√£o --</option>
                                <option value="Jardim Europa" data-fee="9.00">Jardim Europa (R$ 9,00)</option>
                                <option value="Amec" data-fee="9.00">Amec (R$ 9,00)</option>
                                <option value="Vale dos Sonhos 1" data-fee="9.00">Vale dos Sonhos 1 (R$ 9,00)</option>
                                <option value="Vale dos Sonhos 2" data-fee="9.00">Vale dos Sonhos 2 (R$ 9,00)</option>
                                <option value="Vale da Ben√ß√£o" data-fee="9.00">Vale da Ben√ß√£o (R$ 9,00)</option>
                                <option value="Jardim do Lago" data-fee="12.00">Jardim do Lago (R$ 12,00)</option>
                                <option value="Casas Populares" data-fee="9.00">Casas Populares (R$ 9,00)</option>
                                <option value="Nova Esperan√ßa 2" data-fee="9.00">Nova Esperan√ßa 2 (R$ 9,00)</option>
                                <option value="Outro Bairro" data-fee="7.00">Outro Bairro (Taxa Padr√£o R$ 7,00)</option>
                            </select>
                        </div>
                        <div>
                            <label for="customer-address" class="block text-sm font-medium text-gray-400">Endere√ßo Completo (Rua, N√∫mero, Complemento)</label>
                            <input type="text" id="customer-address" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base" placeholder="Ex: Rua das Flores, 123, apt 4" required>
                        </div>
                    </div>
                     <div>
                        <label for="payment-method" class="block text-sm font-medium text-gray-400">Forma de Pagamento</label>
                        <select id="payment-method" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base">
                            <option>Pix</option>
                            <option>Cart√£o de Cr√©dito (na entrega)</option>
                            <option>Cart√£o de D√©bito (na entrega)</option>
                            <option>Dinheiro</option>
                        </select>
                        <p class="text-xs text-yellow-400 mt-2"><i class="fas fa-info-circle mr-1"></i>Observa√ß√£o: n√£o aceitamos VR e vales refei√ß√£o no momento.</p>
                    </div>
                     <div>
                        <label for="observations" class="block text-sm font-medium text-gray-400">Observa√ß√µes</label>
                        <textarea id="observations" rows="3" class="mt-1 block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base" placeholder="Ex: Troco para R$50, sem cebola, etc."></textarea>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700 flex justify-between items-center">
                 <div>
                    <span class="text-lg font-medium text-gray-300">Total do Pedido:</span>
                    <span id="cart-total" class="text-2xl font-bold text-purple-400 ml-2">R$ 0,00</span>
                </div>
                <button onclick="app.finalizeOrder()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2">
                    <i class="fab fa-whatsapp"></i> Finalizar Pedido
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-lg text-center p-8">
            <div id="confirmation-icon"><i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i></div>
            <h3 id="confirmation-title" class="text-2xl font-bold text-gray-100 mb-2">Pedido Recebido!</h3>
            <p id="confirmation-message" class="text-gray-400 mb-6">Seu pedido foi gerado! Clique no bot√£o abaixo para encaminh√°-lo para o WhatsApp da loja e finalizar a compra.</p>
            <div id="order-summary" class="text-left bg-gray-700 p-4 rounded-lg mb-6 max-h-60 overflow-y-auto modal-body"></div>
            <div id="initial-confirm-buttons" class="flex flex-col sm:flex-row gap-4 justify-center">
                 <button onclick="app.sendOrderViaWhatsApp()" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-all flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp"></i> Enviar Pedido
                </button>
                <button onclick="app.closeConfirmationModal()" class="w-full bg-gray-600 text-gray-100 font-bold py-3 px-6 rounded-lg hover:bg-gray-500 transition-all">Fechar</button>
            </div>
            <div id="post-send-buttons" class="hidden flex-col gap-4 justify-center">
                 <p class="text-sm text-yellow-400 mb-4">Ap√≥s enviar a mensagem no WhatsApp, confirme abaixo para limpar seu carrinho.</p>
                 <button onclick="app.confirmOrderSent()" class="w-full bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-check-square"></i> Pedido Enviado, Limpar Carrinho
                </button>
                <button onclick="app.closeConfirmationModal()" class="w-full bg-gray-600 text-gray-100 font-bold py-3 px-6 rounded-lg hover:bg-gray-500 transition-all">Manter Carrinho e Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Alert Modal -->
    <div id="alert-modal" class="alert-modal fixed inset-0 bg-black bg-opacity-60 z-[60] hidden items-center justify-center p-4 opacity-0">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-sm text-center p-6 transform scale-95 transition-transform">
            <div id="alert-icon" class="mx-auto mb-4"></div>
            <h3 id="alert-title" class="text-xl font-bold text-gray-100 mb-2">Aten√ß√£o!</h3>
            <p id="alert-message" class="text-gray-400 mb-6">Mensagem de alerta.</p>
            <button onclick="app.closeAlertModal()" class="w-full bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-all">OK</button>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-[70] hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-amber-400"><i class="fas fa-user-shield mr-2"></i>Painel do Administrador</h3>
                <button onclick="app.closeAdminModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="admin-body" class="p-6 space-y-6 overflow-y-auto modal-body">
                <!-- Admin panel content will be rendered here by JavaScript -->
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700 flex flex-wrap justify-between items-center gap-4">
                <div class="flex gap-4">
                    <button onclick="app.saveAdminChanges()" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-all flex items-center gap-2">
                        <i class="fas fa-save"></i> Salvar Altera√ß√µes
                    </button>
                    <button onclick="app.resetToDefaults()" class="bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-700 transition-all flex items-center gap-2 text-sm">
                        <i class="fas fa-undo"></i> Restaurar Padr√£o
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <div id="password-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-[80] hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-sm text-center p-6">
            <h3 class="text-xl font-bold text-amber-400 mb-4">Acesso Restrito</h3>
            <p class="text-gray-400 mb-4">Por favor, insira a senha de administrador.</p>
            <input type="password" id="admin-password-input" class="block w-full bg-gray-700 border-2 border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 p-3 text-base" placeholder="Senha">
            <div class="mt-6 flex gap-4">
                <button onclick="app.closePasswordModal()" class="w-full bg-gray-600 text-gray-100 font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-all">Cancelar</button>
                <button onclick="app.checkAdminPassword()" class="w-full bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-all">Entrar</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Action Modal (Generic) -->
    <div id="confirm-action-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-[80] hidden items-center justify-center p-4">
        <div class="bg-gray-800 text-gray-200 rounded-2xl shadow-2xl w-full max-w-sm text-center p-6">
            <div id="confirm-action-icon" class="mx-auto mb-4"><i class="fas fa-exclamation-triangle text-yellow-500 text-5xl"></i></div>
            <h3 id="confirm-action-title" class="text-xl font-bold text-gray-100 mb-2">Confirmar A√ß√£o</h3>
            <p id="confirm-action-message" class="text-gray-400 mb-6">Voc√™ tem certeza?</p>
            <div class="mt-6 flex gap-4">
                <button id="confirm-action-cancel-btn" class="w-full bg-gray-600 text-gray-100 font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-all">Cancelar</button>
                <button id="confirm-action-confirm-btn" class="w-full bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-all">Confirmar</button>
            </div>
        </div>
    </div>
    
    <script>
    // --- APP GLOBAL OBJECT ---
    // Encapsulates all application state and logic for better organization.
    const app = {
        // --- APPLICATION STATE ---
        cart: [],
        currentItem: null,
        whatsAppMessage: '',
        isStoreOpen: false,
        isDeliveryTime: false, // Tracks if it's past the current day's delivery start hour
        adminSettings: {},
        products: [],
        toppings: {},
        selectedComboProductId: null, // New state to hold the ID of the combo being configured

        // --- DEFAULT DATA (for initial load or reset) ---
        defaultAdminSettings: {
            storeStatus: 'auto', // 'auto', 'open', 'closed'
            deliveryMode: 'both', // 'both', 'delivery', 'takeout'
            openingTime: '15:15', // 3:15 PM
            closingTime: '22:15', // 10:15 PM
            openDays: [0, 1, 2, 3, 4, 5, 6], // Sunday = 0, Monday = 1, etc.
            whatsappNumber: '5594991623576',
            address: 'Av. Rio Branco, Bairro Novo Horizonte, prox a pra√ßa',
            weekdayDeliveryStartTime: '18:00', // 6 PM
            weekendDeliveryStartTime: '15:30'  // 3:30 PM for Saturday (6) and Sunday (0)
        },
        defaultProducts: [
            { id: 1, name: 'Copo 300ml', price: 14.00, disabled: false, type: 'base_acai', description: '' },
            { id: 2, name: 'Copo 400ml', price: 17.00, disabled: false, type: 'base_acai', description: '' },
            { id: 3, name: 'Copo 500ml', price: 20.00, disabled: false, type: 'base_acai', description: '' },
            { id: 4, name: 'Barca M', price: 55.00, disabled: false, type: 'base_acai', description: '' },
            // Special Combos - now selectable size
            { id: 5, name: 'Diet Granola', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: granola, leite em p√≥, leite condensado' },
            { id: 6, name: 'Refrescante', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: sorvete, calda de chocolate, leite em p√≥, leite condensado' },
            { id: 7, name: 'Mega Especial', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: leite em p√≥, leite condensado, banana, creme de avel√£ (Nutella)' },
            { id: 8, name: 'Preferido', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: pa√ßoca, leite em p√≥, leite condensado, creme de avel√£ (Nutella)' },
            { id: 9, name: 'Maltine +', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: ovomaltine, tapioca, leite em p√≥, leite condensado' },
            { id: 10, name: 'Amendoimix', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: amendoim, leite em p√≥, leite condensado' },
            { id: 11, name: 'Megapower', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: chocopower, leite em p√≥, leite condensado, creme de avel√£ (Nutella)' },
            { id: 12, name: 'A√ßa√≠ Banana', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: leite em p√≥, tapioca, leite condensado, banana' },
            { id: 13, name: 'Favorito Nutella', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: flocos, leite condensado, leite em p√≥, creme de avel√£ (Nutella)' },
            { id: 14, name: 'Sabores do Par√°', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: banana, uva, leite em p√≥, leite condensado, creme de avel√£ (Nutella)' },
            { id: 15, name: 'Kids Especial', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: M&M\'s, uva, creme de avel√£ (Nutella), leite em p√≥, leite condensado, banana' },
            { id: 16, name: 'Namorados', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: uva, morango, creme de avel√£ (Nutella), leite em p√≥, leite condensado' },
            { id: 17, name: 'Kitkat', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: KitKat, creme de avel√£, leite em p√≥, calda de chocolate' },
            { id: 18, name: 'Euforia', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: morango, kiwi, banana, leite em p√≥, calda de morango' },
            { id: 19, name: 'Ninho', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: creme de Ninho, creme de avel√£, calda de chocolate' },
            { id: 20, name: 'Bombom', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: Sonho de Valsa, leite em p√≥, calda de chocolate, creme de avel√£' },
            { id: 21, name: 'Maracuj√°', disabled: false, type: 'combo_selectable_size', description: 'Sugest√£o: mousse de maracuj√°, creme de avel√£, leite em p√≥, calda de chocolate' },
        ],
        cupSizes: [ // Define cup sizes and their prices
            { name: '300ml', price: 14.00 },
            { name: '400ml', price: 17.00 },
            { name: '500ml', price: 20.00 }
        ],
        defaultToppings: {
            // Merged 'free' and 'grains' categories
            free: {
                title: 'üçì Frutas, Cremes e Gr√£os (Gr√°tis, escolha at√© 3)', limit: 3, items: [
                    { name: 'Sorvete', disabled: false }, { name: 'Banana', disabled: false }, { name: 'Morango', disabled: false }, 
                    { name: 'Manga', disabled: false }, { name: 'Kiwi', disabled: false }, { name: 'Uva', disabled: false }, 
                    { name: 'Abacaxi', disabled: false }, { name: 'Creme de Leite Ninho', disabled: false }, { name: 'Creme de Cupua√ßu', disabled: false }, 
                    { name: 'Creme de Avel√£', disabled: false }, { name: 'Mousse de Maracuj√°', disabled: false },
                    { name: 'Granola Tradicional', disabled: false }, { name: 'Aveia', disabled: false }, { name: 'Flocos', disabled: false }, 
                    { name: 'Tapioca', disabled: false }, { name: 'Pa√ßoca', disabled: false }, { name: 'Leite em P√≥', disabled: false }, 
                    { name: 'Amendoim', disabled: false }, { name: 'Coco Ralado', disabled: false }
                ]
            },
            caldas: {
                title: 'üçØ Caldas (Gr√°tis, escolha at√© 2)', limit: 2, items: [
                    { name: 'Leite Condensado', disabled: false }, { name: 'Calda de Chocolate', disabled: false }, { name: 'Calda de Morango', disabled: false }, 
                    { name: 'Calda de Caramelo', disabled: false }, { name: 'Calda de A√ßa√≠', disabled: false }, { name: 'Calda de Kiwi', disabled: false }
                ]
            },
            paid_tier2: {
                title: 'üç´ Doces e Chocolates (+ R$ 2,00 cada)', price: 2.00, items: [ /* Changed price to 2.00 */
                    { name: 'Gotas de Chocolate', disabled: false }, { name: 'Confetes', disabled: false }, { name: 'Bis Picado', disabled: false }, 
                    { name: 'Sonho de Valsa', disabled: false }, { name: 'M&M\'s', disabled: false }, { name: 'Ovomaltine', disabled: false }, { name: 'Chocopower', disabled: false }, { name: 'KitKat', disabled: false }
                ]
            }
        },

        // --- LOCAL STORAGE KEYS ---
        CART_STORAGE_KEY: 'saborAcaiteriaCart',
        CUSTOMER_INFO_STORAGE_KEY: 'saborAcaiteriaCustomerInfo',
        ADMIN_SETTINGS_STORAGE_KEY: 'saborAcaiteriaAdminSettings',
        PRODUCTS_STORAGE_KEY: 'saborAcaiteriaProducts',
        TOPPINGS_STORAGE_KEY: 'saborAcaiteriaToppings',

        // --- DOM ELEMENT SELECTORS (cached for performance) ---
        elements: {
            productList: document.getElementById('product-list'),
            itemModal: document.getElementById('item-modal'),
            cartModal: document.getElementById('cart-modal'),
            confirmationModal: document.getElementById('confirmation-modal'),
            adminModal: document.getElementById('admin-modal'),
            cartButton: document.getElementById('cart-button'),
            alertModal: document.getElementById('alert-modal'),
            customerNameInput: document.getElementById('customer-name'),
            customerAddressInput: document.getElementById('customer-address'),
            neighborhoodSelect: document.getElementById('neighborhood'),
            deliveryFields: document.getElementById('delivery-fields'),
            deliveryOptionRadios: document.querySelectorAll('input[name="delivery_option"]'),
            passwordModal: document.getElementById('password-modal'),
            adminPasswordInput: document.getElementById('admin-password-input'),
            confirmActionModal: document.getElementById('confirm-action-modal'),
            deliveryTimeBanner: document.getElementById('delivery-time-banner'),
            storeHoursDisplay: document.getElementById('store-hours-display'),
            storeStatusIndicator: document.getElementById('store-status-indicator'),
            storeStatusBanner: document.getElementById('store-status-banner'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalItemTotal: document.getElementById('modal-item-total'),
            addToCartBtn: document.getElementById('add-to-cart-btn'),
            cartItemsContainer: document.getElementById('cart-items-container'),
            cartTotalEl: document.getElementById('cart-total'),
            cartCountEl: document.getElementById('cart-count'),
            checkoutForm: document.getElementById('checkout-form'),
            summaryDetails: document.getElementById('cart-summary-details'),
            cartSubtotal: document.getElementById('cart-subtotal'),
            cartDeliveryFee: document.getElementById('cart-delivery-fee'),
            deliveryOptionDelivery: document.getElementById('delivery-option-delivery'),
            deliveryOptionTakeout: document.getElementById('delivery-option-takeout'),
            paymentMethod: document.getElementById('payment-method'),
            observations: document.getElementById('observations'),
            orderSummary: document.getElementById('order-summary'),
            confirmationIcon: document.getElementById('confirmation-icon'),
            confirmationTitle: document.getElementById('confirmation-title'),
            confirmationMessage: document.getElementById('confirmation-message'),
            initialConfirmButtons: document.getElementById('initial-confirm-buttons'),
            postSendButtons: document.getElementById('post-send-buttons'),
            alertMessage: document.getElementById('alert-message'),
            alertTitle: document.getElementById('alert-title'),
            alertIcon: document.getElementById('alert-icon'),
            adminBody: document.getElementById('admin-body'),
            confirmActionMessage: document.getElementById('confirm-action-message'),
            confirmActionConfirmBtn: document.getElementById('confirm-action-confirm-btn'),
            confirmActionCancelBtn: document.getElementById('confirm-action-cancel-btn'),
            storeAddressDisplay: document.getElementById('store-address-display'),
            whatsappLink: document.getElementById('whatsapp-link'),
            comboSizeModal: document.getElementById('combo-size-modal'),
            comboSizeModalTitle: document.getElementById('combo-size-modal-title'),
            comboSizeModalBody: document.getElementById('combo-size-modal-body'),
            selectComboSizeBtn: document.getElementById('select-combo-size-btn'),
        },

        // --- HELPER FUNCTIONS ---
        formatCurrency(value) {
            return `R$ ${value.toFixed(2).replace('.', ',')}`;
        },

        // --- LOCAL STORAGE FUNCTIONS ---
        saveCart() { localStorage.setItem(app.CART_STORAGE_KEY, JSON.stringify(app.cart)); },
        loadCart() {
            const savedCart = localStorage.getItem(app.CART_STORAGE_KEY);
            if (savedCart) app.cart = JSON.parse(savedCart);
        },
        saveCustomerInfo() {
            const info = {
                name: app.elements.customerNameInput.value,
                address: app.elements.customerAddressInput.value,
                neighborhood: app.elements.neighborhoodSelect.value,
                deliveryOption: document.querySelector('input[name="delivery_option"]:checked')?.value
            };
            localStorage.setItem(app.CUSTOMER_INFO_STORAGE_KEY, JSON.stringify(info));
        },
        loadCustomerInfo() {
            const savedInfo = localStorage.getItem(app.CUSTOMER_INFO_STORAGE_KEY);
            if (savedInfo) {
                const info = JSON.parse(savedInfo);
                app.elements.customerNameInput.value = info.name || '';
                app.elements.customerAddressInput.value = info.address || '';
                app.elements.neighborhoodSelect.value = info.neighborhood || '';
                if (info.deliveryOption) {
                    const radio = document.querySelector(`input[name="delivery_option"][value="${info.deliveryOption}"]`);
                    if (radio) radio.checked = true;
                }
            }
        },
        loadLocalData() {
            const savedSettings = localStorage.getItem(app.ADMIN_SETTINGS_STORAGE_KEY);
            // Merge saved settings with defaults to ensure new properties are present
            app.adminSettings = savedSettings ? { ...app.defaultAdminSettings, ...JSON.parse(savedSettings) } : app.defaultAdminSettings;

            const savedProducts = localStorage.getItem(app.PRODUCTS_STORAGE_KEY);
            app.products = savedProducts ? JSON.parse(savedProducts) : app.defaultProducts;

            const savedToppings = localStorage.getItem(app.TOPPINGS_STORAGE_KEY);
            app.toppings = savedToppings ? JSON.parse(savedToppings) : app.defaultToppings;
        },

        // --- CUSTOM ALERT FUNCTION ---
        showAlert(message, title = 'Aten√ß√£o!', isError = false) {
            app.elements.alertMessage.textContent = message;
            app.elements.alertTitle.textContent = title;
            if (isError) {
                app.elements.alertIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500 text-5xl"></i>';
            } else {
                app.elements.alertIcon.innerHTML = '<i class="fas fa-check-circle text-green-500 text-5xl"></i>';
            }
            app.elements.alertModal.classList.remove('hidden');
            setTimeout(() => {
                app.elements.alertModal.classList.remove('opacity-0');
                app.elements.alertModal.querySelector('div > div').classList.remove('scale-95');
            }, 10); // Small delay to allow CSS transition
        },
        closeAlertModal() {
            app.elements.alertModal.classList.add('opacity-0');
            app.elements.alertModal.querySelector('div > div').classList.add('scale-95');
            setTimeout(() => { app.elements.alertModal.classList.add('hidden'); }, 300); // Match transition duration
        },

        // --- STORE STATUS LOGIC ---
        renderStoreHoursDisplay() {
            const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
            let daysString = "Fechado todos os dias";

            if (app.adminSettings.openDays.length > 0) {
                if (app.adminSettings.openDays.length === 7) {
                    daysString = "Todos os dias";
                } else {
                    daysString = app.adminSettings.openDays.sort((a, b) => a - b).map(dayIndex => dayNames[dayIndex]).join(', ');
                }
            }
            
            app.elements.storeHoursDisplay.querySelector('span').textContent = `${app.adminSettings.openingTime} √†s ${app.adminSettings.closingTime} (${daysString})`;
        },

        checkStoreStatus() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentDay = now.getDay(); // Sunday = 0, Monday = 1, etc.

            // Determine current delivery start time based on day of week
            const isWeekend = (currentDay === 0 || currentDay === 6); // Sunday or Saturday
            const deliveryStartTimeStr = isWeekend ? app.adminSettings.weekendDeliveryStartTime : app.adminSettings.weekdayDeliveryStartTime;
            const [deliveryStartHour, deliveryStartMinute] = deliveryStartTimeStr.split(':').map(Number);
            
            // Check if store is open based on admin settings
            if (app.adminSettings.storeStatus === 'open') {
                app.isStoreOpen = true;
            } else if (app.adminSettings.storeStatus === 'closed') {
                app.isStoreOpen = false;
            } else { // 'auto'
                const isTodayOpenDay = app.adminSettings.openDays.includes(currentDay);
                if (!isTodayOpenDay) {
                    app.isStoreOpen = false;
                } else {
                    const [openHour, openMinute] = app.adminSettings.openingTime.split(':').map(Number);
                    const [closeHour, closeMinute] = app.adminSettings.closingTime.split(':').map(Number);
                    
                    const openTimeInMinutes = openHour * 60 + openMinute;
                    const closeTimeInMinutes = closeHour * 60 + closeMinute;
                    const currentTimeInMinutes = currentHour * 60 + currentMinute;

                    // Handle closing time crossing midnight
                    if (closeTimeInMinutes < openTimeInMinutes) { // E.g., opens 22:00, closes 02:00
                        app.isStoreOpen = (currentTimeInMinutes >= openTimeInMinutes || currentTimeInMinutes <= closeTimeInMinutes);
                    } else {
                        app.isStoreOpen = (currentTimeInMinutes >= openTimeInMinutes && currentTimeInMinutes <= closeTimeInMinutes);
                    }
                }
            }

            // Check if it's past the delivery start time for today
            const currentDeliveryTimeInMinutes = currentHour * 60 + currentMinute;
            const deliveryStartTimeInMinutes = deliveryStartHour * 60 + deliveryStartMinute;
            app.isDeliveryTime = currentDeliveryTimeInMinutes >= deliveryStartTimeInMinutes;

            // Update store status indicator and banner
            if (app.isStoreOpen) {
                app.elements.storeStatusIndicator.textContent = 'Aberto';
                app.elements.storeStatusIndicator.className = 'ml-2 px-3 py-1 text-sm rounded-full bg-green-500 text-white font-bold';
                app.elements.storeStatusBanner.innerHTML = '';
                app.elements.storeStatusBanner.classList.add('hidden');
            } else {
                app.elements.storeStatusIndicator.textContent = 'Fechado';
                app.elements.storeStatusIndicator.className = 'ml-2 px-3 py-1 text-sm rounded-full bg-red-500 text-white font-bold';
                app.elements.storeStatusBanner.innerHTML = `
                    <div class="bg-red-900/50 border-l-4 border-red-500 text-red-300 p-4 rounded-md mb-8 text-center" role="alert">
                        <p class="font-bold text-lg">No momento estamos fechados!</p>
                        <p class="text-sm">Voc√™ pode navegar pelo card√°pio, mas os pedidos est√£o suspensos.</p>
                    </div>
                `;
                app.elements.storeStatusBanner.classList.remove('hidden');
            }

            // Update product buttons based on store status
            app.renderProducts(); // Re-render products to update their status display

            // Update delivery time banner
            if (!app.isDeliveryTime && app.isStoreOpen && (app.adminSettings.deliveryMode === 'both' || app.adminSettings.deliveryMode === 'delivery')) {
                app.elements.deliveryTimeBanner.innerHTML = `
                    <div class="bg-blue-900/50 border-l-4 border-blue-500 text-blue-300 p-4 rounded-md mb-8 text-center" role="alert">
                        <p class="font-bold text-lg">Entregas come√ßam a partir das ${deliveryStartTimeStr}h!</p>
                        <p class="text-sm">Voc√™ ainda pode fazer pedidos para retirar na loja.</p>
                    </div>
                `;
                app.elements.deliveryTimeBanner.classList.remove('hidden');
            } else {
                app.elements.deliveryTimeBanner.classList.add('hidden');
                app.elements.deliveryTimeBanner.innerHTML = '';
            }

            app.renderStoreHoursDisplay();
            app.renderDeliveryOptions(); // Update delivery options based on store/delivery status
            app.renderCart(); // Re-render cart to update total/finalize button status
        },

        // --- RENDER FUNCTIONS ---
        renderProducts() {
            app.elements.productList.innerHTML = '';
            app.products.forEach(product => {
                const isDisabled = product.disabled;
                // Determine if it's a base a√ßa√≠ or a customizable combo
                const isComboWithSelectableSize = product.type === 'combo_selectable_size';

                // Conditional classes for the product card
                const cardClasses = isDisabled
                    ? "bg-gray-900 border border-gray-800 rounded-xl p-4 text-center transition-all cursor-not-allowed flex flex-col justify-between opacity-60"
                    : "bg-gray-800 border border-gray-700 rounded-xl p-4 text-center transition-all hover:shadow-lg hover:border-purple-400 cursor-pointer flex flex-col justify-between";
                
                // Conditional classes for the button
                const buttonClasses = isDisabled
                    ? "mt-4 bg-gray-600 text-gray-400 font-semibold py-2 px-4 rounded-lg cursor-not-allowed w-full"
                    : "mt-4 bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-500 transition-all w-full";
                
                // Conditional text for the button
                const buttonText = isDisabled ? "Em Breve" : "Montar";
                
                // Conditional onclick handler
                let onclickHandler;
                if (isDisabled) {
                    onclickHandler = "";
                } else if (isComboWithSelectableSize) {
                    onclickHandler = `onclick="app.openComboSizeModal('${product.id}')"`;
                } else { // base_acai
                    onclickHandler = `onclick="app.openItemModal('${product.id}', ${product.price}, '')"`;
                }
                
                // Conditional text colors for name and price
                const nameColor = isDisabled ? "text-gray-400" : "text-gray-100";
                const priceColor = isDisabled ? "text-gray-500" : "text-purple-400";
                const descriptionColor = isDisabled ? "text-gray-500" : "text-gray-400";

                // Display price only for base a√ßa√≠, not for combos as their price is chosen later
                const priceDisplay = product.type === 'base_acai' ? `<p class="text-2xl font-semibold ${priceColor} mt-2">${app.formatCurrency(product.price)}</p>` : `<p class="text-xl font-semibold ${priceColor} mt-2">A partir de ${app.formatCurrency(app.cupSizes[0].price)}</p>`;


                const productCard = `
                    <div class="${cardClasses}" ${onclickHandler}>
                        <div>
                            <h3 class="font-bold text-xl ${nameColor}">${product.name}</h3>
                            ${product.description ? `<p class="text-sm ${descriptionColor} mt-1">${product.description}</p>` : ''}
                            ${priceDisplay}
                        </div>
                        <button class="${buttonClasses}" ${isDisabled ? 'disabled' : ''}>${buttonText}</button>
                    </div>
                `;
                app.elements.productList.innerHTML += productCard;
            });
        },

        renderCart() {
            if (app.cart.length === 0) {
                app.elements.cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center">Seu carrinho est√° vazio.</p>';
                app.elements.checkoutForm.classList.add('hidden');
                app.elements.summaryDetails.classList.add('hidden');
            } else {
                app.elements.checkoutForm.classList.remove('hidden');
                app.elements.summaryDetails.classList.remove('hidden');
                app.elements.cartItemsContainer.innerHTML = app.cart.map((item, index) => {
                    // Toppings display for all customizable items
                    let toppingsDisplay = '';
                    if (item.type === 'base_acai') {
                        toppingsDisplay = item.toppings.length > 0
                        ? item.toppings.map(t => `<span>- ${t.name} ${t.price > 0 ? `(+ ${app.formatCurrency(t.price)})` : ''}</span>`).join('<br>')
                        : '<span>- A√ßa√≠ puro</span>';
                    } else if (item.type === 'combo_selectable_size') {
                        toppingsDisplay = `<span>Tamanho: ${item.selectedSize}</span><br><span>${item.description.replace('Sugest√£o: ', '')}</span>`;
                    }
                    

                    return `
                        <div class="flex items-start justify-between p-4 border-b border-gray-700">
                            <div>
                                <p class="font-bold text-lg text-gray-100">${item.name} (x${item.quantity})</p>
                                <div class="text-sm text-gray-400 pl-2 mt-1">
                                    ${toppingsDisplay}
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-lg text-purple-400">${app.formatCurrency(item.price * item.quantity)}</p>
                                <div class="flex items-center gap-2 mt-2">
                                    <button onclick="app.updateQuantity(${index}, -1)" class="bg-gray-700 w-7 h-7 rounded-full font-bold text-lg flex items-center justify-center">-</button>
                                    <span class="font-bold w-5 text-center">${item.quantity}</span>
                                    <button onclick="app.updateQuantity(${index}, 1)" class="bg-gray-700 w-7 h-7 rounded-full font-bold text-lg flex items-center justify-center">+</button>
                                    <button onclick="app.removeFromCart(${index})" class="text-red-500 hover:text-red-700 ml-2"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            const subtotal = app.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryOption = document.querySelector('input[name="delivery_option"]:checked')?.value;
            
            let deliveryFee = 0;
            if (deliveryOption === 'delivery' && subtotal > 0) {
                const selectedOption = app.elements.neighborhoodSelect.options[app.elements.neighborhoodSelect.selectedIndex];
                deliveryFee = parseFloat(selectedOption.dataset.fee || 0);
            }
            
            const finalTotal = subtotal + deliveryFee;

            app.elements.cartSubtotal.textContent = app.formatCurrency(subtotal);
            app.elements.cartDeliveryFee.textContent = app.formatCurrency(deliveryFee);
            app.elements.cartTotalEl.textContent = app.formatCurrency(finalTotal);

            // Disable finalize button if store is closed or cart is empty
            const finalizeBtn = document.querySelector('button[onclick="app.finalizeOrder()"]');
            if (finalizeBtn) {
                if (!app.isStoreOpen || app.cart.length === 0) {
                    finalizeBtn.disabled = true;
                    finalizeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    finalizeBtn.disabled = false;
                    finalizeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        },

        // --- DELIVERY OPTION LOGIC ---
        renderDeliveryOptions() {
            const deliveryRadio = app.elements.deliveryOptionDelivery.querySelector('input');
            const takeoutRadio = app.elements.deliveryOptionTakeout.querySelector('input');
            const deliveryOptionsContainer = document.getElementById('delivery-options');

            // Determine current delivery start time for display
            const now = new Date();
            const currentDay = now.getDay(); // Sunday = 0, Monday = 1, etc.
            const isWeekend = (currentDay === 0 || currentDay === 6); // Sunday or Saturday
            const deliveryStartTimeStr = isWeekend ? app.adminSettings.weekendDeliveryStartTime : app.adminSettings.weekdayDeliveryStartTime;

            // Reset states
            app.elements.deliveryOptionDelivery.classList.add('hidden');
            app.elements.deliveryOptionDelivery.classList.remove('opacity-50', 'cursor-not-allowed');
            deliveryRadio.disabled = false;
            app.elements.deliveryOptionDelivery.querySelector('.radio-title').textContent = 'Delivery (Entrega)';
            app.elements.deliveryOptionDelivery.querySelector('.text-sm').textContent = '20-60 min';

            app.elements.deliveryOptionTakeout.classList.add('hidden');
            app.elements.deliveryOptionTakeout.classList.remove('opacity-50', 'cursor-not-allowed');
            takeoutRadio.disabled = false;
            app.elements.deliveryOptionTakeout.querySelector('.radio-title').textContent = 'Retirar na Loja';
            app.elements.deliveryOptionTakeout.querySelector('.text-sm').textContent = '20-30 min';

            let availableOptions = [];

            // Apply admin settings for delivery mode
            if (app.adminSettings.deliveryMode === 'both' || app.adminSettings.deliveryMode === 'delivery') {
                app.elements.deliveryOptionDelivery.classList.remove('hidden');
                availableOptions.push('delivery');
            }
            if (app.adminSettings.deliveryMode === 'both' || app.adminSettings.deliveryMode === 'takeout') {
                app.elements.deliveryOptionTakeout.classList.remove('hidden');
                availableOptions.push('takeout');
            }

            // Apply delivery time restriction
            if (!app.isDeliveryTime && (app.adminSettings.deliveryMode === 'both' || app.adminSettings.deliveryMode === 'delivery')) {
                deliveryRadio.disabled = true;
                app.elements.deliveryOptionDelivery.classList.add('opacity-50', 'cursor-not-allowed');
                app.elements.deliveryOptionDelivery.querySelector('.radio-title').textContent = 'Delivery (Indispon√≠vel)';
                app.elements.deliveryOptionDelivery.querySelector('.text-sm').textContent = `Dispon√≠vel a partir das ${deliveryStartTimeStr}h`;
                // Remove 'delivery' from available options if it's disabled due to time
                availableOptions = availableOptions.filter(option => option !== 'delivery');
            }

            if (availableOptions.length === 0) {
                deliveryOptionsContainer.classList.add('hidden');
            } else {
                deliveryOptionsContainer.classList.remove('hidden');
            }

            // Ensure a valid option is selected if the previously selected one is now disabled
            const currentSelected = document.querySelector('input[name="delivery_option"]:checked');
            if (!currentSelected || currentSelected.closest('label').classList.contains('hidden') || currentSelected.disabled) {
                if (availableOptions.includes('takeout') && !takeoutRadio.disabled) {
                    takeoutRadio.checked = true;
                } else if (availableOptions.includes('delivery') && !deliveryRadio.disabled) {
                    deliveryRadio.checked = true;
                } else {
                    // If no options are available or selectable, ensure none are checked
                    deliveryRadio.checked = false;
                    takeoutRadio.checked = false;
                }
            }
            
            app.toggleDeliveryFields();
        },

        toggleDeliveryFields() {
            const deliveryOption = document.querySelector('input[name="delivery_option"]:checked')?.value;
            if (deliveryOption === 'takeout' || !deliveryOption) {
                app.elements.deliveryFields.classList.add('hidden');
            } else {
                app.elements.deliveryFields.classList.remove('hidden');
            }
            app.renderCart(); // Re-calculate cart total with potentially updated delivery fee
        },

        // --- MODAL LOGIC ---
        openModal(modalElement) {
            modalElement.classList.remove('hidden');
            modalElement.classList.add('flex');
            // Timeout to trigger CSS transition
            setTimeout(() => {
                modalElement.classList.add('modal-active');
            }, 10);
        },
        closeModal(modalElement) {
            modalElement.classList.remove('modal-active');
            // Timeout to allow CSS transition to complete before hiding
            setTimeout(() => {
                modalElement.classList.remove('flex');
                modalElement.classList.add('hidden');
            }, 300); // Match CSS transition duration
        },

        // --- COMBO SIZE SELECTION MODAL ---
        openComboSizeModal(productId) {
            if (!app.isStoreOpen) {
                app.showAlert('A loja est√° fechada e n√£o √© poss√≠vel montar pedidos agora.', 'Loja Fechada', true);
                return;
            }
            app.selectedComboProductId = productId; // Store the combo ID
            const product = app.products.find(p => p.id.toString() === productId.toString());
            if (!product) return;

            app.elements.comboSizeModalTitle.textContent = `Escolha o Tamanho para ${product.name}`;
            app.elements.comboSizeModalBody.innerHTML = '';

            app.cupSizes.forEach(size => {
                const sizeOptionHtml = `
                    <label class="flex items-center space-x-3 p-3 border-2 border-gray-600 rounded-lg cursor-pointer has-[:checked]:border-purple-500 has-[:checked]:bg-purple-900/50">
                        <input type="radio" name="combo_size" value="${size.name}" data-price="${size.price}" class="hidden">
                        <div class="flex items-center w-full">
                            <span class="mr-3 text-purple-400 text-xl"><i class="fas fa-mug-hot"></i></span>
                            <div>
                                <span class="font-semibold text-gray-300 block radio-title">${size.name}</span>
                                <span class="text-sm text-gray-400">${app.formatCurrency(size.price)}</span>
                            </div>
                        </div>
                    </label>
                `;
                app.elements.comboSizeModalBody.innerHTML += sizeOptionHtml;
            });

            // Enable/disable continue button based on selection
            app.elements.comboSizeModalBody.querySelectorAll('input[name="combo_size"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    app.elements.selectComboSizeBtn.disabled = !document.querySelector('input[name="combo_size"]:checked');
                });
            });

            app.elements.selectComboSizeBtn.disabled = true; // Initially disabled
            app.elements.selectComboSizeBtn.onclick = () => {
                const selectedSizeRadio = document.querySelector('input[name="combo_size"]:checked');
                if (selectedSizeRadio) {
                    const selectedSizeName = selectedSizeRadio.value;
                    const selectedSizePrice = parseFloat(selectedSizeRadio.dataset.price);
                    
                    // Directly add the combo to the cart with selected size and price
                    const comboProduct = app.products.find(p => p.id.toString() === app.selectedComboProductId.toString());
                    if (comboProduct) {
                        app.currentItem = {
                            id: comboProduct.id,
                            name: comboProduct.name,
                            basePrice: selectedSizePrice, // Base price is the selected cup size price
                            price: selectedSizePrice, // Final price is also the selected cup size price (no extra toppings)
                            quantity: 1,
                            toppings: [], // No additional toppings for this type of combo
                            type: comboProduct.type,
                            selectedSize: selectedSizeName,
                            description: comboProduct.description // Keep original description for summary
                        };
                        app.addToCart(); // Add to cart
                    }
                    app.closeComboSizeModal(); // Close the size selection modal after adding to cart
                }
            };

            app.openModal(app.elements.comboSizeModal);
        },

        closeComboSizeModal() {
            app.closeModal(app.elements.comboSizeModal);
            app.selectedComboProductId = null; // Clear the selected combo ID
        },

        // --- ITEM CUSTOMIZATION MODAL ---
        openItemModal(productId, selectedBasePrice, selectedSizeName = '') {
            const product = app.products.find(p => p.id.toString() === productId.toString());
            if (!product) return;
            
            // Set currentItem with the selected base price and size name
            app.currentItem = {
                id: productId, 
                name: product.name, 
                basePrice: selectedBasePrice, 
                price: selectedBasePrice, 
                quantity: 1, 
                toppings: [], 
                type: product.type,
                selectedSize: selectedSizeName // Store the selected size for combos
            };

            // Adjust modal title if a size was selected for a combo
            if (selectedSizeName) {
                app.elements.modalTitle.textContent = `Monte seu ${product.name} (${selectedSizeName})`;
            } else {
                app.elements.modalTitle.textContent = `Monte seu ${product.name}`;
            }
            
            app.elements.modalBody.innerHTML = '';

            const warningNote = `<div class="bg-yellow-900/50 border-l-4 border-yellow-500 text-yellow-300 p-4 rounded-md" role="alert"><div class="flex"><div class="py-1"><i class="fas fa-info-circle mr-3"></i></div><div><p class="font-bold">Aten√ß√£o!</p><p class="text-sm">Escolha seus adicionais com carinho. Nossos copos t√™m espa√ßo limitado e talvez n√£o seja poss√≠vel incluir todos os itens selecionados.</p></div></div></div>`;
            app.elements.modalBody.innerHTML += warningNote;

            // Display combo description if applicable
            if (product.type === 'combo_selectable_size' && product.description) {
                const comboDescriptionHtml = `<div class="bg-purple-900/50 border-l-4 border-purple-500 text-purple-300 p-4 rounded-md mb-4" role="alert"><p class="font-bold">Este combo sugere:</p><p class="text-sm">${product.description.replace('Sugest√£o: ', '')}</p></div>`;
                app.elements.modalBody.innerHTML += comboDescriptionHtml;
            }

            Object.entries(app.toppings).forEach(([key, category]) => {
                const section = document.createElement('div');
                let itemsHTML = category.items
                    .filter(item => !item.disabled) // Filter out disabled items
                    .map(item => `
                    <label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-700 cursor-pointer">
                        <input type="checkbox" class="h-5 w-5 rounded border-gray-500 bg-gray-600 text-purple-600 focus:ring-purple-500" name="${key}" value="${item.name}" data-price="${category.price || 0}">
                        <span class="text-gray-300">${item.name}</span>
                    </label>
                `).join('');
                
                if (itemsHTML.length > 0) {
                    section.innerHTML = `<h4 class="text-lg font-bold text-gray-200 mb-2 pb-1 border-b border-gray-600">${category.title}</h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-2">${itemsHTML}</div>`;
                    app.elements.modalBody.appendChild(section);
                }
            });
            
            app.elements.modalBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', app.updateModalItemTotal);
            });

            app.updateModalItemTotal();
            app.openModal(app.elements.itemModal);
        },

        closeItemModal() {
            app.closeModal(app.elements.itemModal);
            app.currentItem = null;
        },

        updateModalItemTotal() {
            let totalFromToppings = 0;
            const currentToppingsList = [];

            Object.entries(app.toppings).forEach(([key, category]) => {
                const checkboxes = app.elements.modalBody.querySelectorAll(`input[name="${key}"]`);
                const checkedCheckboxes = app.elements.modalBody.querySelectorAll(`input[name="${key}"]:checked`);

                if (category.limit) {
                    if (checkedCheckboxes.length >= category.limit) {
                        checkboxes.forEach(cb => { if (!cb.checked) cb.disabled = true; });
                    } else {
                        checkboxes.forEach(cb => { cb.disabled = false; });
                    }
                }
                
                checkedCheckboxes.forEach(checkbox => {
                    const price = parseFloat(checkbox.dataset.price);
                    if (price > 0) totalFromToppings += price;
                    currentToppingsList.push({ name: checkbox.value, price: price });
                });
            });
            
            app.currentItem.price = app.currentItem.basePrice + totalFromToppings;
            // Sort toppings for consistent order in cart display
            app.currentItem.toppings = currentToppingsList.sort((a, b) => a.name.localeCompare(b.name)); 
            app.elements.modalItemTotal.textContent = app.formatCurrency(app.currentItem.price);
        },

        toggleCartModal() {
            app.renderDeliveryOptions(); // Ensure options are up-to-date
            app.renderCart();
            if (app.elements.cartModal.classList.contains('hidden')) {
                app.openModal(app.elements.cartModal);
            } else {
                app.closeModal(app.elements.cartModal);
            }
        },

        closeConfirmationModal() {
            app.closeModal(app.elements.confirmationModal);
            // Reset confirmation modal content after closing
            setTimeout(() => {
                app.elements.confirmationIcon.innerHTML = '<i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>';
                app.elements.confirmationTitle.textContent = 'Pedido Recebido!';
                // Updated message here
                app.elements.confirmationMessage.textContent = 'Seu pedido foi gerado! Clique no bot√£o abaixo para encaminh√°-lo para o WhatsApp da loja e finalizar a compra.';
                app.elements.initialConfirmButtons.classList.remove('hidden');
                app.elements.initialConfirmButtons.classList.add('flex');
                app.elements.postSendButtons.classList.add('hidden');
                app.elements.postSendButtons.classList.remove('flex');
            }, 300);
        },

        // --- CART LOGIC ---
        addToCart() {
            const existingItemIndex = app.cart.findIndex(item => {
                // Check if it's the same product ID, same type, same size (if applicable), and the same set of toppings
                if (item.id !== app.currentItem.id || item.type !== app.currentItem.type) return false;
                if (item.type === 'combo_selectable_size' && item.selectedSize !== app.currentItem.selectedSize) return false;

                // For base_acai, compare toppings. For combo_selectable_size, toppings will always be empty.
                if (item.type === 'base_acai' && item.toppings.length !== app.currentItem.toppings.length) return false;
                if (item.type === 'base_acai') {
                    const currentToppingsString = app.currentItem.toppings.map(t => `${t.name}-${t.price}`).sort().join(',');
                    const existingToppingsString = item.toppings.map(t => `${t.name}-${t.price}`).sort().join(',');
                    return currentToppingsString === existingToppingsString;
                }
                
                return true; // For combo_selectable_size, if ID and size match, it's the same item
            });

            if (existingItemIndex > -1) {
                app.cart[existingItemIndex].quantity++;
            } else {
                app.cart.push({ ...app.currentItem });
            }
            
            app.saveCart();
            app.renderCart();
            app.updateCartIcon();
        },

        updateQuantity(index, change) {
            if (app.cart[index].quantity + change > 0) {
                app.cart[index].quantity += change;
            } else {
                app.removeFromCart(index);
                return; // Exit to prevent further processing if item was removed
            }
            app.saveCart();
            app.renderCart();
            app.updateCartIcon();
        },

        removeFromCart(index) {
            app.cart.splice(index, 1);
            app.saveCart();
            app.renderCart();
            app.updateCartIcon();
        },

        updateCartIcon() {
            const totalItems = app.cart.reduce((sum, item) => sum + item.quantity, 0);
            app.elements.cartCountEl.textContent = totalItems;
            if (totalItems > 0) {
                app.elements.cartButton.classList.remove('hidden');
            } else {
                 app.elements.cartButton.classList.add('hidden');
                 if (app.elements.cartModal.classList.contains('flex')) {
                     app.toggleCartModal(); // Close cart modal if empty
                 }
            }
        },

        // --- ORDER FINALIZATION LOGIC ---
        finalizeOrder() {
            if (!app.isStoreOpen) {
                app.showAlert('A loja est√° fechada e n√£o est√° aceitando pedidos no momento.', 'Loja Fechada', true);
                return;
            }

            if (app.cart.length === 0) {
                app.showAlert('Seu carrinho est√° vazio!', 'Carrinho Vazio', true);
                return;
            }

            const name = app.elements.customerNameInput.value.trim();
            const address = app.elements.customerAddressInput.value.trim();
            const neighborhood = app.elements.neighborhoodSelect.value;
            const payment = app.elements.paymentMethod.value;
            const obs = app.elements.observations.value.trim();
            const deliveryOption = document.querySelector('input[name="delivery_option"]:checked')?.value;

            if (!deliveryOption) {
                app.showAlert('Nenhuma op√ß√£o de entrega/retirada est√° dispon√≠vel no momento. Por favor, verifique as configura√ß√µes da loja.', 'Ops!', true);
                return;
            }

            if (!name) {
                app.showAlert('Por favor, preencha seu Nome para continuar.', 'Dados Incompletos', true);
                app.elements.customerNameInput.focus();
                return;
            }

            // Get current delivery start time for the alert message
            const now = new Date();
            const currentDay = now.getDay(); // Sunday = 0, Monday = 1, etc.
            const isWeekend = (currentDay === 0 || currentDay === 6); // Sunday or Saturday
            const deliveryStartTimeStr = isWeekend ? app.adminSettings.weekendDeliveryStartTime : app.adminSettings.weekdayDeliveryStartTime;

            // New check for delivery time
            if (deliveryOption === 'delivery' && !app.isDeliveryTime) {
                app.showAlert(`As entregas s√≥ come√ßam a partir das ${deliveryStartTimeStr}h. Por favor, escolha "Retirar na Loja" ou aguarde.`, 'Hor√°rio de Entrega', true);
                return;
            }
            
            let deliveryFee = 0;
            let summary = `*NOVO PEDIDO - SABOR A√áA√çTERIA*\n\n*Cliente:* ${name}\n`;

            if (deliveryOption === 'delivery') {
                if (!address || !neighborhood) {
                    app.showAlert('Por favor, selecione o Bairro e preencha o Endere√ßo para entrega.', 'Dados Incompletos', true);
                    if (!neighborhood) app.elements.neighborhoodSelect.focus();
                    else app.elements.customerAddressInput.focus();
                    return;
                }
                summary += `*Op√ß√£o:* ENTREGA\n*Tempo Estimado:* 20-60 min\n*Endere√ßo:* ${address}, ${neighborhood}\n\n`;
                const selectedOption = app.elements.neighborhoodSelect.options[app.elements.neighborhoodSelect.selectedIndex];
                deliveryFee = parseFloat(selectedOption.dataset.fee || 0);
            } else {
                summary += `*Op√ß√£o:* RETIRAR NA LOJA\n*Tempo Estimado:* 20-30 min\n\n`;
            }

            summary += `*ITENS DO PEDIDO:*\n------------------------\n`;
            app.cart.forEach(item => {
                summary += `*${item.quantity}x ${item.name}*`;
                // If it's a combo with selectable size, add its size and base description
                if (item.type === 'combo_selectable_size' && item.selectedSize) {
                    summary += ` (${item.selectedSize})`;
                    if (item.description) {
                        summary += ` - ${item.description.replace('Sugest√£o: ', '')}`;
                    }
                }
                summary += `\n`;
                if (item.type === 'base_acai') { // Only list toppings for base a√ßa√≠
                    if (item.toppings.length > 0) {
                        item.toppings.forEach(t => { summary += `  - ${t.name}${t.price > 0 ? ` (+${app.formatCurrency(t.price)})` : ''}\n`; });
                    } else {
                        summary += `  - A√ßa√≠ puro\n`;
                    }
                } else if (item.type === 'combo_selectable_size') {
                    summary += `  - Sem adicionais nem complementos.\n`;
                }
                summary += `Subtotal: ${app.formatCurrency(item.price * item.quantity)}\n------------------------\n`;
            });

            const subtotal = app.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const finalTotal = subtotal + deliveryFee;
            summary += `\n*Subtotal dos Itens: ${app.formatCurrency(subtotal)}*\n`;
            if (deliveryOption === 'delivery') summary += `*Taxa de Entrega: ${app.formatCurrency(deliveryFee)}*\n`;
            summary += `*TOTAL DO PEDIDO: ${app.formatCurrency(finalTotal)}*\n*Forma de Pagamento:* ${payment}\n`;
            if (obs) summary += `*Observa√ß√µes:* ${obs}\n`;

            app.whatsAppMessage = encodeURIComponent(summary);
            // Display summary in HTML, replacing newlines with <br> and bolding text between asterisks
            app.elements.orderSummary.innerHTML = summary.replace(/\n/g, '<br>').replace(/\*(.*?)\*/g, '<strong>$1</strong>');
            
            app.closeModal(app.elements.cartModal); 
            app.openModal(app.elements.confirmationModal);
        },

        sendOrderViaWhatsApp() {
            const url = `https://wa.me/${app.adminSettings.whatsappNumber}?text=${app.whatsAppMessage}`;
            window.open(url, '_blank');
            
            app.elements.confirmationIcon.innerHTML = '<i class="fab fa-whatsapp-square text-green-400 text-6xl mb-4"></i>';
            app.elements.confirmationTitle.textContent = 'Quase l√°!';
            app.elements.confirmationMessage.textContent = 'A janela do WhatsApp foi aberta. Ap√≥s enviar sua mensagem, clique no bot√£o abaixo para confirmar e limpar seu carrinho.';
            app.elements.initialConfirmButtons.classList.add('hidden');
            app.elements.postSendButtons.classList.remove('hidden');
            app.elements.postSendButtons.classList.add('flex');
        },

        confirmOrderSent() {
            app.cart = [];
            app.saveCart();
            app.closeConfirmationModal();
            app.renderCart();
            app.updateCartIcon();
            app.showAlert('√ìtimo! Seu carrinho foi limpo. Aguarde a confirma√ß√£o da loja no WhatsApp.', 'Pedido Enviado');
        },

        // --- ADMIN PANEL LOGIC ---
        openAdminPanel(event) {
            event.preventDefault(); // Prevent default link behavior
            app.openModal(app.elements.passwordModal);
            app.elements.adminPasswordInput.focus();
        },

        closePasswordModal() {
            app.closeModal(app.elements.passwordModal);
            app.elements.adminPasswordInput.value = ''; // Clear password input
        },

        checkAdminPassword() {
            const password = app.elements.adminPasswordInput.value;
            // NOTE: For a real application, this password should be securely managed (e.g., hashed, stored server-side).
            // This is a client-side example for demonstration.
            if (password === "admin123") { // DEFAULT PASSWORD - CHANGE IF DESIRED
                app.closePasswordModal();
                app.renderAdminPanel();
                app.openModal(app.elements.adminModal);
            } else {
                app.closePasswordModal();
                app.showAlert("Senha incorreta!", 'Acesso Negado', true);
            }
        },

        closeAdminModal() {
            app.closeModal(app.elements.adminModal);
        },

        renderAdminPanel() {
            app.elements.adminBody.innerHTML = ''; // Clear previous content

            // Section for Store Settings
            const daysOfWeek = ["Domingo", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
            let daysCheckboxesHTML = daysOfWeek.map((day, index) => `
                <label class="flex items-center gap-2 p-1.5 rounded-md hover:bg-gray-700 cursor-pointer">
                    <input type="checkbox" name="admin_open_day" value="${index}" class="h-4 w-4 rounded text-purple-600 focus:ring-purple-500" ${app.adminSettings.openDays.includes(index) ? 'checked' : ''}>
                    <span>${day}</span>
                </label>
            `).join('');

            let settingsHTML = `
                <div class="p-4 bg-gray-900/50 rounded-lg">
                    <h4 class="text-xl font-bold text-purple-400 mb-4">Configura√ß√µes Gerais</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                         <div>
                            <label for="admin-whatsapp-number" class="block text-sm font-medium text-gray-300 mb-1">N√∫mero do WhatsApp</label>
                            <input type="text" id="admin-whatsapp-number" value="${app.adminSettings.whatsappNumber}" class="bg-gray-700 p-2 rounded-md border border-gray-600 w-full" placeholder="Ex: 5511999998888">
                        </div>
                         <div>
                            <label for="admin-address" class="block text-sm font-medium text-gray-300 mb-1">Endere√ßo da Loja</label>
                            <input type="text" id="admin-address" value="${app.adminSettings.address}" class="bg-gray-700 p-2 rounded-md border border-gray-600 w-full">
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-900/50 rounded-lg mt-6">
                    <h4 class="text-xl font-bold text-purple-400 mb-4">Controle de Funcionamento</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div>
                            <h5 class="font-semibold text-gray-300 mb-2">Status da Loja</h5>
                            <div class="space-y-2">
                                <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_store_status" value="auto" class="h-4 w-4 mr-2 text-purple-600 focus:ring-purple-500" ${app.adminSettings.storeStatus === 'auto' ? 'checked' : ''}> Autom√°tico (por hor√°rio)</label>
                                <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_store_status" value="open" class="h-4 w-4 mr-2 text-purple-600 focus:ring-purple-500" ${app.adminSettings.storeStatus === 'open' ? 'checked' : ''}> Aberto (Manual)</label>
                                <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_store_status" value="closed" class="h-4 w-4 mr-2 text-purple-600 focus:ring-purple-500" ${app.adminSettings.storeStatus === 'closed' ? 'checked' : ''}> Fechado (Manual)</label>
                            </div>
                        </div>
                        <div>
                            <h5 class="font-semibold text-gray-300 mb-2">Op√ß√µes de Pedido</h5>
                             <div class="space-y-2">
                                <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_delivery_mode" value="both" class="h-4 w-4 mr-2 text-purple-600 focus:ring-purple-500" ${app.adminSettings.deliveryMode === 'both' ? 'checked' : ''}> Delivery e Retirada</label>
                                <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_delivery_mode" value="delivery" class="h-4 w-4 mr-2 text-purple-600 focus:ring-purple-500" ${app.adminSettings.deliveryMode === 'delivery' ? 'checked' : ''}> Apenas Delivery</label>
                                <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="radio" name="admin_delivery_mode" value="takeout" class="h-4 w-4 mr-2 text-purple-600 focus:ring-purple-500" ${app.adminSettings.deliveryMode === 'takeout' ? 'checked' : ''}> Apenas Retirada</label>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                             <h5 class="font-semibold text-gray-300 mb-2">Hor√°rio de Funcionamento (Modo Autom√°tico)</h5>
                             <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div class="sm:col-span-2">
                                    <h6 class="text-sm font-medium text-gray-400 mb-1">Dias da Semana</h6>
                                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-2 text-sm">
                                        ${daysCheckboxesHTML}
                                    </div>
                                </div>
                                <div>
                                    <h6 class="text-sm font-medium text-gray-400 mb-1">Hor√°rio de Abertura/Fechamento</h6>
                                    <div class="flex items-center gap-2">
                                        <input type="time" id="admin-opening-time" value="${app.adminSettings.openingTime}" class="bg-gray-700 p-2 rounded-md border border-gray-600 w-full">
                                        <span>√†s</span>
                                        <input type="time" id="admin-closing-time" value="${app.adminSettings.closingTime}" class="bg-gray-700 p-2 rounded-md border border-gray-600 w-full">
                                    </div>
                                </div>
                                <div class="md:col-span-2">
                                    <h6 class="text-sm font-medium text-gray-400 mb-1">Hor√°rio de In√≠cio da Entrega</h6>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="admin-weekday-delivery-start-time" class="block text-xs font-medium text-gray-400 mb-1">Dias de Semana (Seg-Mex)</label>
                                            <input type="time" id="admin-weekday-delivery-start-time" value="${app.adminSettings.weekdayDeliveryStartTime}" class="bg-gray-700 p-2 rounded-md border border-gray-600 w-full">
                                        </div>
                                        <div>
                                            <label for="admin-weekend-delivery-start-time" class="block text-xs font-medium text-gray-400 mb-1">Fins de Semana (S√°b-Dom)</label>
                                            <input type="time" id="admin-weekend-delivery-start-time" value="${app.adminSettings.weekendDeliveryStartTime}" class="bg-gray-700 p-2 rounded-md border border-gray-600 w-full">
                                        </div>
                                    </div>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            `;
            app.elements.adminBody.innerHTML += settingsHTML;

            // Section for Products (Tamanhos and Combos)
            let productsHTML = `<div class="p-4 bg-gray-900/50 rounded-lg mt-6"><h4 class="text-xl font-bold text-purple-400 mb-4">Card√°pio: Produtos (Tamanhos e Combos)</h4><div id="admin-products-list" class="space-y-3">`;
            app.products.forEach((product, index) => {
                const isComboSelectableSize = product.type === 'combo_selectable_size';
                productsHTML += `
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-center p-2 bg-gray-700 rounded-md admin-item" data-type="product" data-original-id="${product.id}">
                        <input type="text" value="${product.name}" class="admin-name col-span-2 bg-gray-600 p-2 rounded-md border border-gray-500" placeholder="Nome do Produto">
                        <input type="number" step="0.01" value="${product.price ? product.price.toFixed(2) : '0.00'}" class="admin-price bg-gray-600 p-2 rounded-md border border-gray-500 ${isComboSelectableSize ? 'hidden' : ''}" placeholder="Pre√ßo">
                        <select class="admin-type bg-gray-600 p-2 rounded-md border border-gray-500">
                            <option value="base_acai" ${product.type === 'base_acai' ? 'selected' : ''}>A√ßa√≠ Base</option>
                            <option value="combo_selectable_size" ${product.type === 'combo_selectable_size' ? 'selected' : ''}>Combo (Escolhe Tamanho)</option>
                        </select>
                        <div class="flex items-center justify-between gap-2">
                            <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" class="admin-disabled h-5 w-5" ${product.disabled ? 'checked' : ''}> Bloquear</label>
                            <button onclick="app.removeAdminItem(this)" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <textarea class="admin-description col-span-full bg-gray-600 p-2 rounded-md border border-gray-500 ${isComboSelectableSize ? '' : 'hidden'}" placeholder="Descri√ß√£o (para combos)">${product.description}</textarea>
                    </div>`;
            });
            productsHTML += `</div><button onclick="app.addAdminItem('product')" class="mt-4 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-500 text-sm"><i class="fas fa-plus mr-2"></i>Adicionar Produto</button></div>`;
            app.elements.adminBody.innerHTML += productsHTML;

            // Add event listeners for type change to toggle description and price fields
            app.elements.adminBody.querySelectorAll('.admin-type').forEach(select => {
                select.addEventListener('change', (event) => {
                    const parentDiv = event.target.closest('.admin-item');
                    const descriptionField = parentDiv.querySelector('.admin-description');
                    const priceField = parentDiv.querySelector('.admin-price');
                    if (event.target.value === 'combo_selectable_size') {
                        descriptionField.classList.remove('hidden');
                        priceField.classList.add('hidden'); // Hide price for combos with selectable size
                    } else {
                        descriptionField.classList.add('hidden');
                        descriptionField.value = ''; // Clear description if changing to base_acai
                        priceField.classList.remove('hidden'); // Show price for base a√ßa√≠
                    }
                });
            });

            // Section for Toppings
            let toppingsHTML = `<div class="p-4 bg-gray-900/50 rounded-lg mt-6"><h4 class="text-xl font-bold text-purple-400 mb-4">Card√°pio: Complementos</h4>`;
            Object.entries(app.toppings).forEach(([key, category]) => {
                toppingsHTML += `<div class="mt-4"><h5 class="font-semibold text-gray-300 mb-2">${category.title}</h5><div id="admin-toppings-${key}" class="space-y-2">`;
                (category.items || []).forEach((item, index) => {
                    toppingsHTML += `
                        <div class="flex items-center gap-3 p-2 bg-gray-700 rounded-md admin-item" data-type="topping" data-category="${key}">
                            <input type="text" value="${item.name}" class="admin-name flex-grow bg-gray-600 p-2 rounded-md border border-gray-500" placeholder="Nome do Complemento">
                            <label class="flex items-center gap-2 text-sm cursor-pointer whitespace-nowrap"><input type="checkbox" class="admin-disabled h-5 w-5" ${item.disabled ? 'checked' : ''}> Bloquear</label>
                            <button onclick="app.removeAdminItem(this)" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                        </div>`;
                });
                toppingsHTML += `</div><button onclick="app.addAdminItem('topping', '${key}')" class="mt-3 bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-500 text-xs"><i class="fas fa-plus mr-1"></i>Adicionar Complemento</button></div>`;
            });
            toppingsHTML += `</div>`;
            app.elements.adminBody.innerHTML += toppingsHTML;
        },

        addAdminItem(type, categoryKey = '') {
            const newItemId = Date.now();
            const newItemHTML = (type === 'product')
                ? `<div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-center p-2 bg-gray-700 rounded-md admin-item" data-type="product" data-original-id="${newItemId}">
                       <input type="text" value="Novo Produto" class="admin-name col-span-2 bg-gray-600 p-2 rounded-md border border-gray-500">
                       <input type="number" step="0.01" value="0.00" class="admin-price bg-gray-600 p-2 rounded-md border border-gray-500">
                       <select class="admin-type bg-gray-600 p-2 rounded-md border border-gray-500">
                           <option value="base_acai" selected>A√ßa√≠ Base</option>
                           <option value="combo_selectable_size">Combo (Escolhe Tamanho)</option>
                       </select>
                       <div class="flex items-center justify-between gap-2">
                           <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" class="admin-disabled h-5 w-5"> Bloquear</label>
                           <button onclick="app.removeAdminItem(this)" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                       </div>
                       <textarea class="admin-description col-span-full bg-gray-600 p-2 rounded-md border border-gray-500 hidden" placeholder="Descri√ß√£o (para combos)"></textarea>
                   </div>`
                : `<div class="flex items-center gap-3 p-2 bg-gray-700 rounded-md admin-item" data-type="topping" data-category="${categoryKey}">
                       <input type="text" value="Novo Complemento" class="admin-name flex-grow bg-gray-600 p-2 rounded-md border border-gray-500">
                       <label class="flex items-center gap-2 text-sm cursor-pointer whitespace-nowrap"><input type="checkbox" class="admin-disabled h-5 w-5"> Bloquear</label>
                       <button onclick="app.removeAdminItem(this)" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                   </div>`;
            
            const containerId = (type === 'product') ? 'admin-products-list' : `admin-toppings-${categoryKey}`;
            document.getElementById(containerId).insertAdjacentHTML('beforeend', newItemHTML);

            // If adding a product, add event listener for the new type select
            if (type === 'product') {
                const newSelect = document.querySelector(`#admin-products-list .admin-item[data-original-id="${newItemId}"] .admin-type`);
                newSelect.addEventListener('change', (event) => {
                    const parentDiv = event.target.closest('.admin-item');
                    const descriptionField = parentDiv.querySelector('.admin-description');
                    const priceField = parentDiv.querySelector('.admin-price');
                    if (event.target.value === 'combo_selectable_size') {
                        descriptionField.classList.remove('hidden');
                        priceField.classList.add('hidden');
                    } else {
                        descriptionField.classList.add('hidden');
                        descriptionField.value = '';
                        priceField.classList.remove('hidden');
                    }
                });
            }
        },

        removeAdminItem(button) {
            button.closest('.admin-item').remove();
        },
        
        saveAdminChanges() {
            // Save settings
            const newAdminSettings = {
                storeStatus: document.querySelector('input[name="admin_store_status"]:checked').value,
                deliveryMode: document.querySelector('input[name="admin_delivery_mode"]:checked').value,
                openingTime: document.getElementById('admin-opening-time').value,
                closingTime: document.getElementById('admin-closing-time').value,
                openDays: Array.from(document.querySelectorAll('input[name="admin_open_day"]:checked')).map(cb => parseInt(cb.value)),
                whatsappNumber: document.getElementById('admin-whatsapp-number').value,
                address: document.getElementById('admin-address').value,
                weekdayDeliveryStartTime: document.getElementById('admin-weekday-delivery-start-time').value,
                weekendDeliveryStartTime: document.getElementById('admin-weekend-delivery-start-time').value,
            };
            localStorage.setItem(app.ADMIN_SETTINGS_STORAGE_KEY, JSON.stringify(newAdminSettings));
            app.adminSettings = newAdminSettings;
            
            // Save products
            const newProducts = [];
            document.querySelectorAll('#admin-products-list .admin-item').forEach(item => {
                const name = item.querySelector('.admin-name').value;
                const type = item.querySelector('.admin-type').value;
                const disabled = item.querySelector('.admin-disabled').checked;
                const description = item.querySelector('.admin-description').value;
                const originalId = parseInt(item.dataset.originalId);

                let price = 0;
                if (type === 'base_acai') {
                    price = parseFloat(item.querySelector('.admin-price').value);
                }
                
                if (name && (type === 'combo_selectable_size' || !isNaN(price))) {
                    newProducts.push({ id: originalId || Date.now(), name, price, disabled, type, description });
                }
            });
            localStorage.setItem(app.PRODUCTS_STORAGE_KEY, JSON.stringify(newProducts));
            app.products = newProducts;

            // Save toppings
            const newToppings = {};
            Object.keys(app.toppings).forEach(key => {
                const categoryItems = [];
                document.querySelectorAll(`#admin-toppings-${key} .admin-item`).forEach(item => {
                    const name = item.querySelector('.admin-name').value;
                    const disabled = item.querySelector('.admin-disabled').checked;
                    if (name) {
                        categoryItems.push({ name, disabled });
                    }
                });
                newToppings[key] = { ...app.toppings[key], items: categoryItems };
            });
            localStorage.setItem(app.TOPPINGS_STORAGE_KEY, JSON.stringify(newToppings));
            app.toppings = newToppings;
            
            app.showAlert('Configura√ß√µes salvas com sucesso!', 'Salvo!', false);
            app.closeAdminModal();
            app.initializeApp(); // Re-initialize app to apply new settings
        },

        showConfirmationModal(message, onConfirm) {
            app.elements.confirmActionMessage.textContent = message;
            
            // Clone buttons to remove old event listeners and attach new ones
            const oldConfirmBtn = app.elements.confirmActionConfirmBtn;
            const newConfirmBtn = oldConfirmBtn.cloneNode(true);
            oldConfirmBtn.parentNode.replaceChild(newConfirmBtn, oldConfirmBtn);

            const oldCancelBtn = app.elements.confirmActionCancelBtn;
            const newCancelBtn = oldCancelBtn.cloneNode(true);
            oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);

            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                app.closeConfirmationActionModal();
            }, { once: true }); // Use { once: true } to automatically remove listener after first click

            newCancelBtn.addEventListener('click', () => {
                app.closeConfirmationActionModal();
            }, { once: true });

            app.openModal(app.elements.confirmActionModal);
        },

        closeConfirmationActionModal() {
            app.closeModal(app.elements.confirmActionModal);
        },

        resetToDefaults() {
            app.showConfirmationModal(
                "Tem certeza que deseja restaurar o card√°pio e as configura√ß√µes para os valores padr√£o? Todas as suas altera√ß√µes ser√£o perdidas.",
                () => {
                    localStorage.removeItem(app.PRODUCTS_STORAGE_KEY);
                    localStorage.removeItem(app.TOPPINGS_STORAGE_KEY);
                    localStorage.removeItem(app.ADMIN_SETTINGS_STORAGE_KEY);
                    app.closeAdminModal();
                    app.showAlert('Card√°pio e configura√ß√µes restaurados! A p√°gina ser√° recarregada.', 'Sucesso', false);
                    setTimeout(() => window.location.reload(), 2500); // Reload page to ensure all defaults are loaded
                }
            );
        },

        // --- INITIALIZATION ---
        initializeApp() {
            app.loadLocalData();
            app.loadCart();
            app.loadCustomerInfo();
            
            app.elements.storeAddressDisplay.textContent = app.adminSettings.address;
            app.elements.whatsappLink.href = `https://wa.me/${app.adminSettings.whatsappNumber}`;

            app.renderProducts();
            app.renderDeliveryOptions();
            app.renderCart();
            app.updateCartIcon();
            app.checkStoreStatus(); // Initial check and setup

            // Event listeners
            // Modified to explicitly close item modal after adding to cart
            app.elements.addToCartBtn.addEventListener('click', () => {
                app.addToCart();
                app.closeItemModal(); 
            });

            app.elements.customerNameInput.addEventListener('input', app.saveCustomerInfo);
            app.elements.customerAddressInput.addEventListener('input', app.saveCustomerInfo);
            app.elements.neighborhoodSelect.addEventListener('change', () => {
                app.saveCustomerInfo();
                app.renderCart(); // Recalculate cart total with new delivery fee
            });
            app.elements.deliveryOptionRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    app.toggleDeliveryFields();
                    app.saveCustomerInfo();
                });
            });
            
            app.elements.adminPasswordInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    app.checkAdminPassword();
                }
            });

            // Set up a timer to periodically check store status (e.g., every minute)
            // This ensures the open/closed status updates automatically without page refresh.
            setInterval(app.checkStoreStatus, 60 * 1000); // Check every minute
        }
    };

    // Start the app when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
        app.initializeApp();
    });

    </script>
</body>
</html>

